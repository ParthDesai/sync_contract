graph TB
    subgraph "ğŸ† BLOCKCHAIN SOURCE OF TRUTH - CONDITIONAL USER CONFIG"
        subgraph "Program State PDA"
            PS["ğŸ‘‘ ProgramState<br/>â€¢ version: u8<br/>â€¢ admin: Pubkey<br/>ğŸ† Program Authority"]
        end
        
        subgraph "User Account PDAs - CONDITIONAL LIFECYCLE"
            UC1["ğŸ‘¤ NEW USER - SubmitData<br/>â€¢ version: u8<br/>â€¢ accumulatedCredits: 0<br/>ğŸ†• FIRST TIME INITIALIZATION<br/>âœ… Account created from scratch"]
            UC2["ğŸ‘¤ EXISTING USER - SubmitData<br/>â€¢ version: u8<br/>â€¢ accumulatedCredits: unchanged<br/>ğŸ”„ PRESERVED EXISTING BALANCE<br/>âœ… Could be 0 or accumulated amount"]
            UC3["ğŸ‘¤ AFTER RATEDATA - Any User<br/>â€¢ version: u8<br/>â€¢ accumulatedCredits: previous + calculated<br/>ğŸ’° CREDITS ACCUMULATED<br/>âœ… Added to existing balance"]
            UC4["ğŸ‘¤ AFTER CLAIMCREDITS - Any User<br/>â€¢ version: u8<br/>â€¢ accumulatedCredits: 0<br/>ğŸ”„ CREDITS RESET<br/>âœ… Tokens minted to wallet"]
        end
        
        subgraph "Data Submission PDAs" 
            DS1["ğŸ“„ DataSubmission - After SubmitData<br/>â€¢ version: u8<br/>â€¢ dataLink: String<br/>â€¢ seedFileHash: String<br/>â€¢ userId: Pubkey<br/>â€¢ dataHeader: Object<br/>â€¢ agentResponse: None<br/>âœ… Waiting for rating<br/>ğŸ’¡ Same for new/existing users"]
            DS2["ğŸ“„ DataSubmission - After RateData<br/>â€¢ version: u8<br/>â€¢ dataLink: String<br/>â€¢ seedFileHash: String<br/>â€¢ userId: Pubkey<br/>â€¢ dataHeader: Object<br/>â€¢ agentResponse: Some AgentResponse<br/>âœ… Rating completed"]
        end
        
        subgraph "Agent Config PDAs"
            AC["ğŸ¤– AgentConfig<br/>â€¢ version: u8<br/>â€¢ isEnabled: bool<br/>ğŸ† Agent Authority"]
        end
        
        subgraph "Agent Response within DataSubmission"
            AR["â­ AgentResponse - Created in RateData<br/>â€¢ agentKey: Pubkey<br/>â€¢ response: bool<br/>â€¢ rating: u8 0-100<br/>â€¢ syntheticFileHash: Option String<br/>â€¢ calculatedCredits: u64<br/>ğŸ† CREDITS TO ADD<br/>ğŸ’° ALWAYS ADDITIVE<br/>ğŸ“ FILE STORAGE REFERENCES"]
        end
        
        subgraph "Token Accounts"
            TOKEN["ğŸª™ SPL Token Account<br/>â€¢ User wallet balance<br/>â€¢ Minted from claimed credits<br/>ğŸ† TOKENIZED REWARDS"]
        end
    end

    subgraph "ğŸ’¾ OFF-CHAIN SYSTEMS & STORAGE"
        subgraph "Backend Database - Cache Only"
            DB["ğŸ—„ï¸ Database<br/>â€¢ seed_id â†’ file_hash mappings<br/>â€¢ file metadata cache<br/>â€¢ performance optimization<br/>âŒ NOT authoritative"]
        end
        
        subgraph "File Storage Platform - File Lifecycle"
            FS1["ğŸ“ File Storage - During Processing<br/>â€¢ Original seed files (temporary)<br/>â€¢ Content-addressed storage<br/>â€¢ Decentralized & immutable<br/>âœ… File storage authority"]
            FS2["ğŸ—‘ï¸ File Storage - After Rating<br/>â€¢ Original seed files DELETED<br/>â€¢ Synthetic files preserved<br/>â€¢ Cleanup after processing<br/>ğŸ§¹ Storage optimization"]
            FS3["ğŸ“ File Storage - Long-term Storage<br/>â€¢ Synthetic data files only<br/>â€¢ Referenced in AgentResponse<br/>â€¢ Permanent decentralized storage<br/>âœ… Persistent valuable data"]
        end
    end

    %% Conditional Flow Relationships
    UC1 -->|"â­ RateData TX"| UC3
    UC2 -->|"â­ RateData TX"| UC3
    UC3 -->|"ğŸ’³ ClaimCredits TX"| UC4
    UC4 -->|"ğŸ“ Next SubmitData - existing user"| UC2
    
    DS1 -->|"â­ RateData TX"| DS2
    DS2 --> AR
    AR -->|"ğŸ’° Credit Addition"| UC3
    UC3 -->|"ğŸª™ Claim Process"| TOKEN
    
    %% File Storage Lifecycle
    FS1 -->|"After rating & synthetic generation"| FS2
    FS2 -->|"Synthetic files preserved"| FS3
    
    %% Cache Relationships - One-way from source of truth
    UC3 -.->|"ğŸ“¥ Cache user stats"| DB
    DS2 -.->|"ğŸ“¥ Cache submission data"| DB
    AR -.->|"ğŸ“¥ Cache rating data"| DB
    FS1 -.->|"ğŸ“¥ Cache seed file mappings"| DB
    FS3 -.->|"ğŸ“¥ Cache synthetic file mappings"| DB
    
    %% Visual Styling with High Contrast
    classDef onchain fill:#4CAF50,stroke:#1B5E20,stroke-width:3px,color:#FFFFFF
    classDef offchain fill:#757575,stroke:#212121,stroke-width:2px,color:#FFFFFF
    classDef fileStorageActive fill:#2196F3,stroke:#0D47A1,stroke-width:3px,color:#FFFFFF
    classDef fileStorageDeleted fill:#FF5722,stroke:#D84315,stroke-width:3px,color:#FFFFFF
    classDef fileStoragePreserved fill:#009688,stroke:#004D40,stroke-width:3px,color:#FFFFFF
    classDef newUser fill:#8BC34A,stroke:#33691E,stroke-width:3px,color:#000000
    classDef existingUser fill:#03A9F4,stroke:#01579B,stroke-width:3px,color:#FFFFFF
    classDef creditsAccumulated fill:#FFC107,stroke:#FF8F00,stroke-width:3px,color:#000000
    classDef creditsReset fill:#F44336,stroke:#B71C1C,stroke-width:3px,color:#FFFFFF
    classDef tokens fill:#9C27B0,stroke:#4A148C,stroke-width:3px,color:#FFFFFF
    
    class PS,DS1,DS2,AC,AR onchain
    class DB offchain
    class FS1 fileStorageActive
    class FS2 fileStorageDeleted
    class FS3 fileStoragePreserved
    class UC1 newUser
    class UC2 existingUser
    class UC3 creditsAccumulated
    class UC4 creditsReset
    class TOKEN tokens

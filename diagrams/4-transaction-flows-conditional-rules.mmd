flowchart LR
    subgraph "Corrected Conditional Transaction Flows"
        subgraph "📤 SUBMIT DATA FLOW - CONDITIONAL USER HANDLING"
            SD1["User Submits Data<br/>seed_id + metadata + file_hash"]
            SD2["⛓️ On-Chain Validation<br/>• Duplicate check<br/>• User authorization<br/>• Data format validation<br/>• File hash verification"]
            SD3["✅ Create DataSubmission<br/>seedFileHash stored<br/>agentResponse = None"]
            SD4["🔍 Check UserConfig Exists"]
            SD5A["✅ INITIALIZE UserConfig<br/>accumulatedCredits = 0<br/>🆕 NEW USER SETUP"]
            SD5B["✅ PRESERVE UserConfig<br/>Keep existing credits<br/>🔄 EXISTING USER"]
            SD6["📡 Emit Event<br/>DataSubmitted - seed_id, file_hash"]
            
            SD1 --> SD2
            SD2 --> SD3
            SD3 --> SD4
            SD4 -->|"❌ UserConfig missing"| SD5A
            SD4 -->|"✅ UserConfig exists"| SD5B
            SD5A --> SD6
            SD5B --> SD6
        end
        
        subgraph "⭐ RATE DATA FLOW - ALWAYS ADDITIVE + CLEANUP"
            RD1["Agent Submits Rating<br/>rating + optional synthetic_file_hash"]
            RD2["⛓️ On-Chain Validation<br/>• Agent authorization<br/>• Submission exists<br/>• No duplicate rating<br/>• File hash format validation"]
            RD2A["🗑️ Delete Original Seed File<br/>• Remove from File Storage<br/>• Cleanup temporary files<br/>• Storage optimization"]
            RD3["✅ Store AgentResponse<br/>rating + calculated_credits<br/>+ synthetic file_hash"]
            RD4["🧮 Calculate Credits<br/>Based on rating 0-100"]
            RD5["✅ Update UserConfig<br/>accumulatedCredits += calculated<br/>💰 ALWAYS ADDITIVE - never reset"]
            RD6["📡 Emit Event<br/>DataRated - file_hashes"]
            
            RD1 --> RD2
            RD2 --> RD2A
            RD2A --> RD3
            RD3 --> RD4
            RD4 --> RD5
            RD5 --> RD6
        end
        
        subgraph "💳 CLAIM CREDITS FLOW - RESET TO ZERO"
            CC1["User Claims Credits<br/>Request token minting"]
            CC2["⛓️ On-Chain Validation<br/>• Check UserConfig balance > 0<br/>• Mint authority<br/>• Token account setup"]
            CC3["🪙 Mint Tokens<br/>Amount = accumulatedCredits"]
            CC4["✅ Reset UserConfig<br/>accumulatedCredits = 0<br/>🔄 READY FOR NEXT CYCLE"]
            CC5["📡 Emit Event<br/>CreditsClaimed"]
            
            CC1 --> CC2
            CC2 --> CC3
            CC3 --> CC4
            CC4 --> CC5
        end
    end
    
    subgraph "Credit State Transitions - Conditional"
        STATE0["👤 No UserConfig<br/>Account doesn't exist<br/>🚫 First time user"]
        STATE1["👤 UserConfig - New User<br/>accumulatedCredits = 0<br/>🆕 After first SubmitData"]
        STATE2["👤 UserConfig - Existing<br/>accumulatedCredits = previous<br/>🔄 After subsequent SubmitData"]
        STATE3["👤 UserConfig - Rated<br/>accumulatedCredits > 0<br/>💰 After RateData"]
        STATE4["👤 UserConfig - Claimed<br/>accumulatedCredits = 0<br/>🔄 After ClaimCredits"]
        
        STATE0 -->|"📝 First SubmitData"| STATE1
        STATE1 -->|"⭐ RateData"| STATE3
        STATE3 -->|"💳 ClaimCredits"| STATE4
        STATE4 -->|"📝 Next SubmitData"| STATE2
        STATE2 -->|"⭐ RateData"| STATE3
        STATE3 -->|"📝 Another SubmitData"| STATE2
    end

    subgraph "Important Conditional Rules"
        RULE1["🚨 SUBMIT DATA RULES<br/>📍 New User: Initialize UserConfig = 0<br/>📍 Existing User: Keep UserConfig unchanged<br/>📍 DataSubmission always created with file_hash<br/>📍 Never modifies existing credits<br/>📍 Conditional account handling"]
        
        RULE2["💰 CREDIT ACCUMULATION + CLEANUP<br/>📊 RateData ALWAYS adds credits<br/>📈 Credits = previous + calculated<br/>🗑️ Deletes original seed files from storage<br/>🧮 Never resets existing credits<br/>⚖️ Accumulative system<br/>🔄 ClaimCredits resets to 0"]
        
        RULE3["🔍 USER DETECTION LOGIC<br/>🆕 New User: No UserConfig exists<br/>🔄 Existing User: UserConfig found<br/>💡 Smart conditional behavior<br/>✅ Preserves user state<br/>🏆 On-chain state management"]
    end

    %% Flow Connections
    SD6 -.->|"Triggers"| RD1
    RD6 -.->|"Enables"| CC1
    
    %% Visual Styling with High Contrast
    classDef submitFlow fill:#2196F3,stroke:#0D47A1,stroke-width:3px,color:#FFFFFF
    classDef rateFlow fill:#4CAF50,stroke:#1B5E20,stroke-width:3px,color:#FFFFFF
    classDef claimFlow fill:#FF9800,stroke:#E65100,stroke-width:3px,color:#000000
    classDef noAccount fill:#F44336,stroke:#B71C1C,stroke-width:3px,color:#FFFFFF
    classDef newUser fill:#8BC34A,stroke:#33691E,stroke-width:3px,color:#000000
    classDef existingUser fill:#03A9F4,stroke:#01579B,stroke-width:3px,color:#FFFFFF
    classDef creditsAwarded fill:#FFC107,stroke:#FF8F00,stroke-width:3px,color:#000000
    classDef creditsReset fill:#9E9E9E,stroke:#424242,stroke-width:3px,color:#FFFFFF
    classDef rules fill:#9C27B0,stroke:#4A148C,stroke-width:3px,color:#FFFFFF
    
    class SD1,SD2,SD3,SD4,SD5A,SD5B,SD6 submitFlow
    class RD1,RD2,RD2A,RD3,RD4,RD5,RD6 rateFlow
    class CC1,CC2,CC3,CC4,CC5 claimFlow
    class STATE0 noAccount
    class STATE1 newUser
    class STATE2,STATE4 existingUser
    class STATE3 creditsAwarded
    class RULE1,RULE2,RULE3 rules

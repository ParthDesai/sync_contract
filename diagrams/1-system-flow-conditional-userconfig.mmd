flowchart TD
    %% User and Frontend Flow
    A["ğŸ‘¤ User"] -->|"1\. Upload Seed File"| B["ğŸŒ Frontend"]
    B -->|"2\. Send File"| C["ğŸ”§ Backend API"]
    
    %% Backend Processing (Non-Critical Data)
    C -->|"3\. Preliminary Check"| D{"ğŸ“‹ File Valid?"}
    D -->|"âŒ Invalid"| E["âš ï¸ Return Error"]
    D -->|"âœ… Valid"| F["ğŸ“ Upload to File Storage<br/>ğŸ†” Generate seed_id<br/>ğŸ’¾ Cache file_hash + metadata"]
    
    %% Response to Frontend
    F -->|"4\. Return seed_id + file_hash"| B
    E -->|"Error Message"| B
    
    %% BLOCKCHAIN SOURCE OF TRUTH STARTS HERE
    B -->|"5\. Display seed_id"| A
    A -->|"6\. Approve Transaction"| G["ğŸ“ SubmitData TX"]
    G -->|"7\. seed_id + metadata"| H["â›“ï¸ Smart Contract<br/>ğŸ† SOURCE OF TRUTH"]
    
    %% On-Chain Data Storage (Critical)
    H -->|"8\. Store DataSubmission"| I["ğŸ’¾ DataSubmission Created<br/>âœ… Authoritative Record"]
    H -->|"9\. Check UserConfig"| J{"ğŸ‘¤ UserConfig Exists?"}
    
    %% Conditional UserConfig Handling
    J -->|"âŒ No"| K["âœ… Initialize UserConfig<br/>accumulatedCredits = 0<br/>ğŸ†• NEW USER SETUP"]
    J -->|"âœ… Yes"| L["âœ… UserConfig Unchanged<br/>Keep existing credits<br/>ğŸ”„ EXISTING USER"]
    
    %% Continue Flow
    K -->|"10a\. Event Emitted"| M["ğŸ“¡ DataSubmitted Event"]
    L -->|"10b\. Event Emitted"| M
    
    %% Agent Detection and Processing
    M -->|"11\. Detect Event"| N["ğŸ¤– AI Agent Backend"]
    N -->|"12\. Fetch from File Storage by hash"| O["ğŸ“Š Rate Seed File<br/>ğŸ’¾ Cache analysis only"]
    O -->|"13\. Generate Rating 0-100"| P{"âš–ï¸ Rating >= 60?"}
    
    %% Conditional Synthetic Data Generation
    P -->|"âŒ Rating < 60"| Q["ğŸ“„ No Synthetic File<br/>ğŸ’¾ Cache result only"]
    P -->|"âœ… Rating >= 60"| R["ğŸ§¬ Generate Synthetic Data<br/>ğŸ“ Upload to File Storage Platform"]
    R -->|"Synthetic File Created"| S["ğŸ“ synthetic_file_hash<br/>ğŸ’¾ Cache File Storage reference"]
    
    %% CRITICAL: Rating Storage On-Chain WITH CREDITS
    Q -->|"14a\. Rating Only"| T["ğŸ“Š Prepare RateData TX<br/>ğŸ† TO BLOCKCHAIN"]
    S -->|"14b\. Rating + synthetic_file_hash"| T
    T -->|"15\. Delete Seed File"| T1["ğŸ—‘ï¸ Delete Seed File from File Storage<br/>ğŸ’¾ Cleanup Original File"]
    T1 -->|"16\. Submit to Contract"| U["â›“ï¸ RateData TX<br/>ğŸ† SOURCE OF TRUTH"]
    
    %% Smart Contract Credit Calculation (Authoritative)
    U -->|"17\. Store AgentResponse"| V["ğŸ’¾ On-Chain Rating Record<br/>âœ… Immutable & Auditable"]
    U -->|"18\. Calculate Credits"| W["ğŸ§® Credit Calculation<br/>âœ… Deterministic On-Chain"]
    W -->|"19\. Update UserConfig"| X["â• Add Credits to Existing<br/>âœ… Credits += calculated<br/>ğŸ† Authoritative Balance"]
    
    %% Final State Updates (Blockchain Authority)
    X -->|"20\. Credits Available"| Y["ğŸ‘¤ User Account<br/>ğŸ† Updated Blockchain Balance"]
    Y -->|"21\. Query On-Chain"| Z["ğŸ’³ Claim Credits<br/>âœ… Based on Chain State"]
    
    %% Important Flow Notes
    AA["ğŸ“ SubmitData Behavior<br/>ğŸ†• New User: Initialize credits = 0<br/>ğŸ”„ Existing User: Keep current credits<br/>âœ… Always creates DataSubmission<br/>ğŸ’¡ Conditional UserConfig handling"]
    BB["â­ RateData Behavior<br/>âœ… Always adds credits<br/>âœ… Credits += calculated amount<br/>âœ… Never resets existing credits<br/>ğŸ’° Accumulative credit system"]
    
    %% Visual Styling with High Contrast
    classDef userAction fill:#2196F3,stroke:#0D47A1,stroke-width:3px,color:#FFFFFF
    classDef backend fill:#9C27B0,stroke:#4A148C,stroke-width:3px,color:#FFFFFF
    classDef smartContract fill:#4CAF50,stroke:#1B5E20,stroke-width:3px,color:#FFFFFF
    classDef agent fill:#FF9800,stroke:#E65100,stroke-width:3px,color:#000000
    classDef decision fill:#FFEB3B,stroke:#F57F17,stroke-width:3px,color:#000000
    classDef cache fill:#9E9E9E,stroke:#424242,stroke-width:2px,color:#FFFFFF
    classDef newUser fill:#8BC34A,stroke:#33691E,stroke-width:3px,color:#000000
    classDef existingUser fill:#03A9F4,stroke:#01579B,stroke-width:3px,color:#FFFFFF
    classDef creditsAwarded fill:#4CAF50,stroke:#1B5E20,stroke-width:4px,color:#FFFFFF
    classDef important fill:#FFC107,stroke:#F57C00,stroke-width:3px,color:#000000
    
    class A,B,G,Z userAction
    class C,F,N,O,R,S backend
    class H,I,U,V,X,Y smartContract
    class M,T,T1 agent
    class D,J,P decision
    class E,Q cache
    class K newUser
    class L existingUser
    class W,X creditsAwarded
    class AA,BB important